---
import { siteConfig } from "../config";
import Parser from "rss-parser";

const parser = new Parser({
  requestOptions: {
    headers: {
      "User-Agent": "Mozilla/5.0", // Trick Medium into responding properly
      Accept: "application/rss+xml"
    },
    customFields: {
      item: ["content:encoded"], // grab full content where image is stored
    },
  }
});
let posts: { title: string; link: string; pubDate: string; image?: string }[] = [];

try {
  const feed = await parser.parseURL(siteConfig.blog.blogFeedUrl);
  
  posts = feed.items.slice(0,3).map((item: any) => {
    // Try to extract first <img> from content
    let imgMatch = item["content:encoded"]?.match(/<img[^>]+src="([^">]+)"/);
    let imageUrl = imgMatch ? imgMatch[1] : undefined;

    return {
      title: item.title ?? "",
      link: item.link ?? "#",
      pubDate: new Date(item.pubDate ?? "").toLocaleDateString(),
      image: imageUrl,
    }
  });
} catch (err) {
  console.error("Failed to fetch Medium feed:", err);
}
---

{
  posts.length > 0 && (
    <section id="blog" class="p-8 sm:p-12 md:p-16 lg:p-24">
      <div>
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-16 items-start">
          <!-- Left Column: Title -->
          <div class="lg:col-span-4">
            <h2 class="text-3xl sm:text-4xl md:text-5xl xl:text-7xl font-bold text-gray-900">
              {siteConfig.blog.blogTitle}
            </h2>
            <div
              class="w-[75px] h-[5px] mt-2 rounded-full"
              style={`background-color: ${siteConfig.accentColor}`}
            />
          </div>

          <!-- Right Column: Blog Cards -->
          <div class="lg:col-span-8">
            <div class="space-y-8">
              <p class="text-lg sm:text-xl md:text-2xl leading-relaxed text-gray-600">
                {siteConfig.blog.blogDescription}
              </p>
              {posts.map((post) => (
                <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4 sm:p-5 md:p-6 hover:shadow-md transition-shadow duration-300">
                  <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4 mb-4">
                    {post.image && (
                      <img
                        src={post.image}
                        alt={post.title}
                        class="w-full sm:w-40 h-40 object-cover rounded-lg shadow"
                      />
                    )}
                    <div class="flex-1">
                      <h3 class="text-lg sm:text-xl font-semibold text-gray-900">
                        <a
                          href={post.link}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="hover:underline"
                          style={`color: ${siteConfig.accentColor}`}
                        >
                          {post.title}
                        </a>
                      </h3>
                      <p class="text-sm sm:text-base text-gray-500 mt-1">
                        {post.pubDate}
                      </p>
                    </div>
                  </div>
                </div>
              ))}

              <!-- View More Button -->
              <div class="pt-4">
                <a
                  href={siteConfig.blog.blogUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-block font-semibold text-lg sm:text-xl px-6 py-3 rounded-xl transition-colors"
                  style={`color: ${siteConfig.accentColor}; border: 2px solid ${siteConfig.accentColor}`}
                  onmouseover={`this.style.backgroundColor='${siteConfig.accentColor}'; this.style.color='#fff';`}
                  onmouseout={`this.style.backgroundColor='transparent'; this.style.color='${siteConfig.accentColor}';`}
                >
                  View More on Medium â†’
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  )
}
